<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <title>F# Data Frame design notes
</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Easy to use .NET library for data manipulation and scientific programming">
    <meta name="author" content="BlueMountain Capital">

    <script src="http://code.jquery.com/jquery-1.8.0.js"></script>
    <script src="http://code.jquery.com/ui/1.8.23/jquery-ui.js"></script>
    <script src="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/css/bootstrap-combined.min.css" rel="stylesheet">

    <link type="text/css" rel="stylesheet" href="/Deedle/ja/../content/style.css" />
    <link type="text/css" rel="stylesheet" href="/Deedle/ja/../content/deedle.css" />
    <script type="text/javascript" src="/Deedle/ja/../content/tips.js"></script>
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="container">
      <div class="masthead">
        <ul class="nav nav-pills pull-right">
          <li><a href="http://fsharp.org">fsharp.org</a></li>
          <li><a href="http://fsharp.github.io/FSharp.Data"><img height="16" width="16" src="http://fsharp.org/images/thumbs/FSharp.Data.png" /> F# Data</a></li>
          <li><a href="http://bluemountaincapital.github.io/FSharpRProvider"><img height=" 16" width="16" src="http://fsharp.org/images/thumbs/FSharpRProvider.png" /> R Provider</a></li>
          <li><a href="http://fsharp.github.io/FSharp.Charting/"><img height="16" width="16" src="http://fsharp.org/images/thumbs/FSharp.Charting.png" /> F# Charting</a></li>
        </ul>
        <h3 class="muted"><a href="/Deedle/ja/index.html">Deedle</a></h3>
      </div>
      <hr />
      <div class="row">
        <div class="span9" id="main">
          
<h1>F# Data Frame design notes</h1>

<p>This is the first version of F# Data Frame library and so we are still actively looking
at how to improve the design. The best place for discussions is either the <a href="https://github.com/BlueMountainCapital/Deedle/issues">issue list
on GitHub</a> or the 
mailing list of the <a href="http://fsharp.org/technical-groups/">F# for Data and Machine Learning</a> 
group (for more broader topics).</p>

<p>The current version of the library implements most of the basic functionality,
but it hopefully provides the right "core" internals that should make it easier to add 
all the additional (useful) features.</p>

<p>When developing the library, we follow the principle that there should be a small number
of <em>primitive</em> or <em>fundamental</em> functions (these are typically provided as members on
the basic objects) that can be used to provide a wide range of useful functions (typically
available as extension members and in F# modules). We are generally quite happy to include
more extension members and functions for commonly used operations, so feel free to contribute!</p>

<h2>Library principles</h2>

<ul>
<li><p><strong>F# and C# friendly</strong> - We want to make sure that the library works from both F# and C#.
For this reason, most functionality is exposed as extension members (using the C# <code>Extension</code>
attribute - so they are only visible in C# and F# 3.1) and as functions in modules
(<code>Frame</code> and <code>Series</code>). These are generally very similar. One difference is that functions
use tuples and F# <code>option&lt;T&gt;</code> and more abbreviations, while extensions use <code>KeyValuePair&lt;K, V&gt;</code>,
<code>OptionalValue&lt;T&gt;</code> (a C#-friendly <code>struct</code> defined in the library).</p></li>
<li><p><strong>Symmetry between rows and columns</strong> - The data in data frame is stored as a list of 
columns and it is good idea to use the data frame in a column-wise way (and there are
more functions for working with column-based frames).</p>
<p>However, the data type <code>Frame&lt;'TRowKey, 'TColKey&gt;</code> is symmetric in that it uses custom
index for access by both columns (series) and rows. You can also access columns/rows as
a series of (nested) series via <code>df.Columns</code> and <code>df.Rows</code>. Although the column key is
typically going to be a string (series name), this is not required and you can e.g. transpose
frame using the <code>df.Transpose()</code> method.</p></li>
<li><p><strong>Missing and NaN values</strong> we assume that data frames can always contain missing values and
so there is no type distinction between frame/series that may have missing values and one
that may not have missing values. Operations available on the frame and series are designed
to handle missing values well - they generally skip over missing values unless you explicitly
try to read a value by a key.</p>
<p>The current version treats certain values as "missing" values, including <code>Double.NaN</code> 
(for numeric values) and <code>null</code> (for <code>Nullable&lt;'T&gt;</code> types and reference types). This 
means that when you create a series from <code>Double.NaN</code>, this is turned into a <em>missing</em> value
and the value is skipped when doing aggregation such as <code>Series.sum</code>. (An alternative would be
to support both <code>NaN</code> and <em>missing</em>, but there is no clear conclusion about what is the 
most useful option.)</p></li>
<li><p><strong>Immutability</strong> - A series is fully immutable data type, but a
data frame supports limited mutation - you can add new series, drop a series &amp; replace
a series (but you cannot mutate the series). The row index of a data frame is mostly immutable -
the only case when it changes is when you create an empty data frame and than add the first
series.</p>
<p>This seems to be useful because it works nicely with the <code>?&lt;-</code> operator and you do not have 
to re-bind when you're writing some research script.</p></li>
</ul>

<h2>Library internals</h2>

<p>The following types are (mostly) not directly visible to the user, but they represent the
"minimal" core that changes infrequently. You could use them when extending the library:</p>

<ul>
<li><p><code>IVector&lt;'TValue&gt;</code> represents a vector (essentially an abstract data
storage) that contains values <code>'TValue</code> that can be accessed via an address
<code>Address</code>. A simple concrete implementation is an array with <code>int</code> addresses,
but we aim to make this abstract - one could use an array of arrays with <code>int64</code>
index for large data sets, lazy vector that loads data from a stream or even
a virtual vector with e.g. Cassandra data source).</p>
<p>An important thing about vectors is that they handle missing values, so vector 
of integers is actually more like <code>array&lt;option&lt;int&gt;&gt;</code> (but we have a custom value 
type so that this is continuous block of memory). We decided that handling missing
values is something that is so important for data frame, that it should be directly
supported rather than done by e.g. storing optional or nullable values. Our 
implementation actually does a simple optimization - if there are no missing values,
it just stores <code>array&lt;int&gt;</code>.</p></li>
<li><p><code>VectorConstruction</code> is a discriminated union (DSL) that describes
construction of vector. For every vector type, there is an <code>IVectorBuilder</code>
that knows how to construct vectors using the construction instructions (these
include things like re-shuffling of elements, appending vectors, getting a sub-range
etc.)</p></li>
<li><p><code>IIndex&lt;'TKey&gt;</code> represents an index - that is, a mapping from keys
of a series or data frame to addresses in a vector. In the simple case, this is just
a hash table that returns the <code>int</code> offset in an array when given a key (e.g.
<code>string</code> or <code>DateTime</code>). A super-simple index would just map <code>int</code> offsets to
<code>int</code> addresses via an identity function (not implemented yet!) - if you have
series or data frame that is simply a list of recrods.</p></li>
</ul>

<p>Now, the following types are directly used:</p>

<ul>
<li><p><code>Series&lt;'TKey, 'TValue&gt;</code> represents a series of values <code>'TValue</code> indexed by an
index <code>'TKey</code>. A series uses an abstract vector, index and vector builder, so it
should work with any data representation. A series provides some standard slicing
operators, projection, filtering etc. There are also some binary operators (multiply
by a scalar, add series, etc.) and addtional operations in the <code>Series</code> module.</p></li>
<li><p><code>Frame&lt;'TRowKey, 'TColumnKey&gt;</code> represents a data frame with rows indexed using
<code>TRowKey</code> (this could be <code>DateTime</code> or just ordinal numbers like <code>int</code>) and columns
indexed by <code>TColumnKey</code> (typically a <code>string</code>). The data in the frame can be
hetrogeneous (e.g. different types of values in different columns) and so accessing
data is dynamic - but you can e.g. get a typed series.</p>
<p>The operations available on the data frame include adding &amp; removing series (which 
aligns the new series according to the row index), joins (again - aligns the series) 
etc. You can also get all rows as a series of (column) series and all columns as a 
series of (row) series - they are available as extension methods and in the <code>Frame</code> module.</p></li>
</ul>

<h2>Discussion and open questions</h2>

<p>We're hoping that the design of the internals is now reasonable, but the end user API may
still be missing some useful functionality (let us know if you need some!) Here are a few
things that we discussed earlier and that we may still look into at some point:</p>

<ul>
<li><p><strong>Time series vs. pivot table</strong> - there is some mismatch between two possible
interpretations and uses of the library. One is for time-series data (e.g. in finance)
where one typically works with dates as row indices. More generally, you can see this
as <em>continous</em> index. It makes sense to do interpolation, sort the observations,
align them, re-scale them etc. (Note that <em>continuous</em> is stronger than <em>ordered</em> -
aside from time, the only continuous measure we can think of is distance-dependent
series.)</p>
<p>The other case is when we have some <em>discrete</em> observations (perhaps a list of 
records with customer data, a list of prices of different stock prices etc.) In this
case, we need more "pivot table" functions etc.</p>
<p>Although these two uses are quite different, we feel that it might make sense to use
the same type for both (just with a different index). The problem is that this might
make the API more complex. Although, if we can keep the distincion in the type, we can
use F# 3.1 extension methods that extend just "discrete data frame" or "continous data 
frame". However, for now all functions are available in <code>Frame</code>/<code>Series</code> module and 
as extension methods that extend any type.</p></li>
<li><p><strong>Type provider</strong> - we are thinking about using type providers to give some additional
safety (like checking column names and types in a data frame). This is currently
on the TODO list - we think we can do something useful here, although it will
certainly be limited.</p>
<p>The current idea is that you migth want to do some research/prototyping using a 
dynamic data frame, but once you're done and have some more stable data, you should
be able to write, say <code>DataFrame&lt;"Open:float,Close:float"&gt;(dynamicDf)</code> and get a
new typed data frame.</p></li>
</ul>

<p>If you have any comments regarding the topics above, please <a href="https://github.com/BlueMountainCapital/Deedle/issues">submit an issue
on GitHub</a> or, if you
are interested in more actively contributing, join
the <a href="http://fsharp.org/technical-groups/">F# for Data and Machine Learning</a> working
group.</p>


        </div>
        <div class="span3">
          <a href="/Deedle/ja/index.html">
            <img src="/Deedle/ja/../images/logo.png" style="width:140px;height:140px;margin:10px 0px 0px 35px;border-style:none;" />
          </a>

          <ul class="nav nav-list" id="menu">
            <li class="nav-header">Deedle</li>
            <li><a href="/Deedle/ja/index.html">ホームページ</a></li>
            <li class="divider"></li>
            <li><a href="https://nuget.org/packages/Deedle">NuGet経由でライブラリを取得</a></li>
            <li><a href="http://github.com/BlueMountainCapital/Deedle">GitHub上のソースコード</a></li>
            <li><a href="http://github.com/BlueMountainCapital/Deedle/blob/master/LICENSE.md">ライセンス</a></li>
            <li><a href="http://github.com/BlueMountainCapital/Deedle/blob/master/RELEASE_NOTES.md">リリースノート</a></li>
            <li><a href="/Deedle/ja/design.html">デザインノート</a></li>
            <li><a href="http://stackoverflow.com/questions/tagged/deedle">質問する！</a></li>
            
            <li class="nav-header">F#で使用する</li>
            <li>
              <a href="/Deedle/ja/tutorial.html">クイックスタートチュートリアル</a>
            </li>
            <li>
              <a href="/Deedle/ja/series.html">時系列の処理</a>
            </li>
            <li>
              <a href="/Deedle/ja/frame.html">データフレームの処理</a>
            </li>
            <li>
              <a href="/Deedle/ja/stats.html">統計および計算</a>
            </li>
            <li>
              <a href="/Deedle/ja/rinterop.html">RとDeedleを組み合わせる</a>
            </li>

            <li class="nav-header">C#で使用する</li>
            <li><a href="/Deedle/ja/csharpintro.html">はじめに</a></li>
            <li>
              <a href="/Deedle/ja/csharpseries.html">時系列データの処理</a>
            </li>
            <li>
              <a href="/Deedle/ja/csharpframe.html">データフレームの処理</a>
            </li>

            <li class="nav-header">ドキュメント</li>
            <li><a href="/Deedle/ja/../reference/index.html">APIリファレンス(En)</a></li>
            <li class="divider"></li>
            <li><a href="/Deedle/ja/../reference/deedle-seriesmodule.html">Series モジュール</a></li>
            <li><a href="/Deedle/ja/../reference/deedle-framemodule.html">Frame モジュール</a></li>
            <li><a href="/Deedle/ja/../reference/deedle-stats.html">Stats モジュール</a></li>

            <li class="nav-header">サンプル</li>
            <li><a href="/Deedle/ja/lazysource.html">遅延データ読み込み</a></li>
          </ul>
        </div>
      </div>
    </div>
    <a href="http://github.com/BlueMountainCapital/Deedle"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png" alt="Fork me on GitHub"></a>
    <script>
      (function (i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
          (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date(); a = s.createElement(o),
        m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
      })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
      ga('create', 'UA-45379232-1', 'bluemountaincapital.github.io');
      ga('send', 'pageview');
    </script>
  </body>
</html>